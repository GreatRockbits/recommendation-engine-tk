{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Recommendation Analytics</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .debug-info {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            padding: 1rem;
            margin-bottom: 1rem;
            font-family: monospace;
            white-space: pre-wrap;
            display: none;
        }
        .chart-container {
            height: 400px;
            position: relative;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <div class="container mx-auto mt-4">
        <h1 class="mb-4">Recommendation Performance Analytics</h1>

        {% if average_time_saved is not None %}
            <div class="alert alert-info">
                <p class="lead mb-0">Average time saved by using AI summaries: <strong>{{ average_time_saved|floatformat:4 }} seconds</strong></p>
            </div>
        {% else %}
            <div class="alert alert-warning">
                <p class="lead mb-0">No performance data available yet.</p>
            </div>
        {% endif %}

        <button id="toggleDebug" class="btn btn-sm btn-secondary mb-3">Show Debug Info</button>

        <div id="debugInfo" class="debug-info">
            <h4>Debug Information:</h4>
            <div>
                <strong>Raw product_names:</strong> {{ product_names }}
            </div>
            <div>
                <strong>Raw summary_times:</strong> {{ summary_times }}
            </div>
            <div>
                <strong>Raw reviews_times:</strong> {{ reviews_times }}
            </div>
            <div>
                <strong>Raw time_saved_values:</strong> {{ time_saved_values }}
            </div>
            <div>
                <strong>Raw review_counts:</strong> {{ review_counts }}
            </div>
            <div><strong>review_numbers:</strong> {{ review_numbers }}</div>
            <div><strong>average_time_saved_by_review:</strong> {{ average_time_saved_by_review }}</div>
            <div><strong>averageSummaryTime:</strong> {{ average_summary_time|floatformat:4 }}</div>
            <div><strong>averageReviewsTime:</strong> {{ average_reviews_time|floatformat:4 }}</div>
            <div id="parsedData"></div>
        </div>

        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h2 class="h4 mb-0">Average Summary Time vs. Average Reviews Time</h2>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="timeComparisonChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h2 class="h4 mb-0">Average Time Saved vs. Number of Reviews</h2>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="timeSavedReviewsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h2 class="h4 mb-0">Performance Data Table</h2>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>Product Name</th>
                                        <th>Summary Time (s)</th>
                                        <th>Reviews Time (s)</th>
                                        <th>Number of Reviews</th>
                                        <th>Time Saved (s)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for data in analytics_data %}
                                    <tr>
                                        <td>{{ data.product_name }}</td>
                                        <td>{{ data.summary_time|floatformat:4 }}</td>
                                        <td>{{ data.reviews_time|floatformat:4 }}</td>
                                        <td>{{ data.num_reviews }}</td>
                                        <td>{{ data.time_saved|floatformat:4 }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="5" class="text-center">No performance data recorded.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Debug toggle functionality
        document.getElementById('toggleDebug').addEventListener('click', function() {
            const debugInfo = document.getElementById('debugInfo');
            if (debugInfo.style.display === 'block') {
                debugInfo.style.display = 'none';
                this.textContent = 'Show Debug Info';
            } else {
                debugInfo.style.display = 'block';
                this.textContent = 'Hide Debug Info';
            }
        });

        // Direct data access approach
        // Create JavaScript arrays from the template variables
        const productNames = [{% for name in product_names %}"{{ name|escapejs }}"{% if not forloop.last %}, {% endif %}{% endfor %}];
        const summaryTimes = [{% for time in summary_times %}{{ time|floatformat:4 }}{% if not forloop.last %}, {% endif %}{% endfor %}];
        const reviewsTimes = [{% for time in reviews_times %}{{ time|floatformat:4 }}{% if not forloop.last %}, {% endif %}{% endfor %}];
        const timeSavedValues = [{% for time in time_saved_values %}{{ time|floatformat:4 }}{% if not forloop.last %}, {% endif %}{% endfor %}];
        const reviewCounts = [{% for count in review_counts %}{{ count }}{% if not forloop.last %}, {% endif %}{% endfor %}];
        const averageSummaryTime = {{ average_summary_time|floatformat:4 }};
        const averageReviewsTime = {{ average_reviews_time|floatformat:4 }};
        const reviewNumbers = [{% for count in review_numbers %}{{ count }}{% if not forloop.last %}, {% endif %}{% endfor %}];
        const averageTimeSavedByReview = [{% for time in average_time_saved_by_review %}{{ time|floatformat:4 }}{% if not forloop.last %}, {% endif %}{% endfor %}];

        // Add to debug info
        document.getElementById('parsedData').innerHTML = `
            <h5 class="mt-3">Parsed Data:</h5>
            <div><strong>productNames:</strong> ${JSON.stringify(productNames)}</div>
            <div><strong>summaryTimes:</strong> ${JSON.stringify(summaryTimes)}</div>
            <div><strong>reviewsTimes:</strong> ${JSON.stringify(reviewsTimes)}</div>
            <div><strong>timeSavedValues:</strong> ${JSON.stringify(timeSavedValues)}</div>
            <div><strong>reviewCounts:</strong> ${JSON.stringify(reviewCounts)}</div>
            <div><strong>reviewNumbers:</strong> ${JSON.stringify(reviewNumbers)}</div>
            <div><strong>averageTimeSavedByReview:</strong> ${JSON.stringify(averageTimeSavedByReview)}</div>
            <div><strong>averageSummaryTime:</strong> ${averageSummaryTime}</div>
            <div><strong>averageReviewsTime:</strong> ${averageReviewsTime}</div>
            <div id="parsedData"></div>
        `;

        // Function to log errors
        function logError(message, error) {
            console.error(message, error);
            const debugInfo = document.getElementById('debugInfo');
            const errorDiv = document.createElement('div');
            errorDiv.innerHTML = `<strong style="color: red">ERROR:</strong> ${message} - ${error.message || error}`;
            debugInfo.appendChild(errorDiv);
            debugInfo.style.display = 'block';
            document.getElementById('toggleDebug').textContent = 'Hide Debug Info';
        }

        // Create the charts if we have data
        try {
            if (productNames.length > 0) {
                // Chart 1: Average Summary Time vs. Average Reviews Time
                try {
                    const timeComparisonCtx = document.getElementById('timeComparisonChart').getContext('2d');
                    new Chart(timeComparisonCtx, {
                        type: 'bar',
                        data: {
                            labels: ['Average Time'], // Use a single label
                            datasets: [{
                                label: 'Average Summary Time (s)',
                                data: [averageSummaryTime], // Single data point
                                backgroundColor: 'rgba(54, 162, 235, 0.7)', // Blue
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }, {
                                label: 'Average Reviews Time (s)',
                                data: [averageReviewsTime], // Single data point
                                backgroundColor: 'rgba(255, 99, 132, 0.7)', // Red
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Time (seconds)'
                                    }
                                }
                            }
                        }
                    });
                } catch (error) {
                    logError("Error creating average time comparison chart", error);
                }

                // Chart 2: Average Time Saved vs. Number of Reviews
                try {
                    const timeSavedReviewsCtx = document.getElementById('timeSavedReviewsChart').getContext('2d');
                    new Chart(timeSavedReviewsCtx, {
                        type: 'bar',
                        data: {
                            labels: reviewNumbers, // Number of reviews on the x-axis
                            datasets: [{
                                label: 'Average Time Saved (s)',
                                data: averageTimeSavedByReview, // Average time saved on the y-axis
                                backgroundColor: 'rgba(75, 192, 192, 0.7)', // Green
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Average Time Saved (seconds)'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Number of Reviews'
                                    },
                                    ticks: {
                                        stepSize: 1 // Ensure integer review counts are displayed
                                    }
                                }
                            }
                        }
                    });
                } catch (error) {
                    logError("Error creating average time saved vs number of reviews chart", error);
                }
            } else {
                document.getElementById('parsedData').innerHTML += `
                    <div style="color: red"><strong>Warning:</strong> No data available for charts</div>
                `;
            }
        } catch (error) {
            logError("General chart error", error);
        }
    </script>
</body>
</html>